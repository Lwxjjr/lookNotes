IP在TCP/IP参考模型中处于第三次（网络层）
网络层作用：实现主机与主机之间的通信，即点对点（end to end）通信

# 网络层/数据链路层
> [!diff] IP/MAC
> IP：主机之间通信用的，负责【没有直连】的两个网络之间通信
> MAC：实现【直连】的两个设备之间通信

>[!example] 
 旅游行程表就相当于网络层，充当远程定位的功能
 行程过程的移动就相当于数据链路层，充当节点传输的功能
 如果只有行程表，无法搭乘交通工具到达目的地
 如果只有车票，无法知道怎么换乘和该搭乘什么交通工具
 途中我们虽然不断变化交通工具，但是旅行行程的起始地址和目的地址始终没有变化
 
![[3.webp]]

所以，计算机网络中需要==【数据链路层】和【网络层】==这个分层才能实现向最终目的地址的通信
**源IP地址和目标IP地址在传输过程中是不会变化的（前提：没有使用 NAT 网络），只有源 MAC 地址和目标 MAC 一直在变化**

---
# IP包头

> [!info] TCP 模块在执行连接、收发、断开等各阶段操作时，都需要委托 IP 模块将数据封装成**网络包**发送给通信对象

![[14.webp]]

> [!info] IP报文生成，IP层加入IP包头，拥有远程定位的能力


![[17.webp]]

 

---
# IP基础知识
为了保证能正常通信，每个设备都需要配置正确的 IP 地址
IPv4 地址由 `32` 位正整数来表示
人类为了方便记忆采用了**点分十进制**的标记方式，也就是将 32 位 IP 地址以每 8 位为组，共分为 `4` 组，每组以「`.`」隔开，再将每组转换成十进制

![[4.webp]]

==IP 地址并不是根据主机台数来配置的，而是以网卡==

## IP地址分类

![[7.webp|525]]

> [!tip] 地址划分为**网络号和主机号**
> 两台计算机要通讯，首先判断是否处于一个广播域中，即网络地址是否相同
> 如果网络地址相同，表示接收方在本网络中，那么可以把数据包直接发送到网络主机

![[8.webp]]

$$
最大主机个数 = 2^{主机号位数} - 2
$$
- 主机号全为 1 指定某个网络下的所有主机，用于广播
- 主机号全为 0 指定某个网络

### 广播地址用于什么？
广播地址用于在**同一个链路中相互连接的主机之间发送数据包**
> [!example] 上课班长喊起立，全班起立
- 在本网络内广播的叫做本地广播
- 在不同网络之间的广播叫做直接广播

### 多播地址
==多播用于**将包发送给特定组内的所有主机**==
> [!example] 老师点名某一排的学生，是指定点名

由于==广播无法穿透路由==，若想给其他网段发送同样的包，就可以使用可以==穿透路由的多播==
![[13.webp]]

D 类和 E 类地址是没有主机号的，所以不可用于主机 IP
- D类常被用于多播
- E类是预留的分类

![[12.webp]]


### IP分类优缺点
> [!tip] 优点
分类地址的优点就是**简单明了、选路（基于网络地址）简单**

> [!warning] 缺点
> 1. **同一网络下没有地址层次，灵活性欠缺**，如一公司使用B类地址，可能需要根据生产环境，测试环境，开发环境划分地址
> 2. **不能很好的与现实网络匹配**
> 	- C类地址包含的最大主机数量太少，估计一个网吧都不够用
> 	- B类地址包含的最大主机数量太多，一般企业基本达不到这个规模，闲着的地址就是浪费
> 	- 这两个缺点可以通过CIDR无分类地址解决


### 无分类地址CIDR
> [!tip] 划分网络号和主机号
> 1. 表示形式 `a.b.c.d/x`，其中`/x`表示为前x位属于网络号
> 2. 子网掩码，掩盖掉主机号，剩下就是网络号（子网掩码 and IP地址 得到 网络号）

### 子网划分

![[18.webp]]

借助子网掩码做子网划分
> [!example] 可以从8位主机号中借2位作为主机号

![[19 1.webp]]

---
## 公有IP/私有IP
在 A、B、C 分类地址，实际上有分公有 IP 地址和私有 IP 地址

![[22.webp]]

公有 IP 地址是有个组织统一分配的，假设你要开一个博客网站，那么你就需要去申请购买一个公有 IP，这样全世界的人才能访问。并且公有 IP 地址基本上要在整个互联网范围内保持唯一

![[23.webp]]


---
## IP地址路由控制
IP地址的网络地址用于进行路由控制
路由控制表中记录着：==网络地址与下一步应该发送至路由器的地址==
主机和路由器都会有各自的路由器控制表

---
## IP分片与重组
每种数据链路的最大传输单元 `MTU` 都是不相同的，出于目的不同
我们最常见数据链路是以太网，它的 MTU 是 `1500` 字节
==当IP 数据包大小大于 MTU 时， IP 数据包就会被分片==
经过分片之后的 IP 数据报在被重组的时候，==只能由目标主机进行==，路由器是不会进行重组的
在分片传输中，一旦某个分片丢失，则会造成整个 IP 数据报作废
==所以 TCP 引入了 `MSS` 也就是在 TCP 层进行分片不由 IP 层分片==
那么对于 UDP 我们尽量不要发送一个大于 `MTU` 的数据报文

---
## IPv6
IPv6优点：
1. 可分配的地址增多
2. 可自动配置地址
3. 包头包首部采用固定的40字节，去掉了包头校验和，简化了首部结构，减轻了浏览器载荷，大大提高了传输的性能
4. 有应对伪造IP地址的网络安全功能以及防止线路窃听的功能

>[!tip] IPv地址标识方法
 IPv4 地址长度共 32 位，是以每 8 位作为一组，并用点分十进制的表示方式
 IPv6 地址长度是 128 位，是以每 16 位作为一组，每组用冒号 「:」 隔开
 
 ![[29 1.webp]]


## IPv4/IPv6首部

![[31.webp]]

IPv6 相比 IPv4 的首部改进：
- **取消了首部校验和字段**，因为在数据链路层和传输层都会校验
- **取消了分片/重新组装相关字段**，不允许中间路由器进行分片重组，只能在源与目标主机
- **取消选项字段**

---
# IP协议相关技术
## DNS
我们在上网的时候，通常使用的方式是域名，而不是 IP 地址，因为域名方便人类记忆
实现这一技术的就是==DNS域名解析==：将域名地址自动转换为具体的IP地址
DNS 底层是 UDP 协议
UDP 协议能够提供低延迟、简单快速、轻量级的特性，更适合DNS这种需要快速响应的域名解析服务

> [!tip] 域名的层级关系
> 域名都是用句号分隔，如www.server.com
> 在域名中，**越靠右**的位置表示其层级**越高**

域名的层级关系类似树状结构：
- 根 DNS 服务器
- 顶级域 DNS 服务器（com）
- 权威 DNS 服务器（server.com）

![[32.webp]]

> [!info] 客户端只要能够找到任意一台 DNS 服务器，就可以通过它找到根域 DNS 服务器，然后再一路顺藤摸瓜找到位于下层的某台目标 DNS 服务器

> [!tip] 域名解析的工作流程
1. 客户端首先会发出一个 DNS 请求，==问 www.server.com 的 IP 是啥，并发给本地 DNS 服务器==（也就是客户端的 TCP/IP 设置中填写的 DNS 服务器地址）
2. 本地域名服务器收到客户端的请求后，==如果缓存里的表格能找到 www.server.com，则它直接返回 IP 地址==。如果没有，==本地 DNS 会去问它的根域名服务器==，根域名服务器是最高层次的，它不直接用于域名解析，但能指明一条道路
3. ==根 DNS 收到来自本地 DNS 的请求后，发现后置是 .com==，说：“www.server.com 这个域名归 .com 区域管理”，我给你 .com 顶级域名服务器地址给你，你去问问它吧
4. 1. 本地 DNS 收到顶级域名服务器的地址后，发起请求问“老二， 你能告诉我 www.server.com 的 IP 地址吗？”
5. 顶级域名服务器说：“仍不清楚请求域名的 IP 地址，但我给你负责 www.server.com 区域的权威 DNS 服务器的地址，你去问它应该能问到”
6. 本地 DNS 将请求发送给权威 DNS 服务器
7. ==权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DN==
8. 本地 DNS 再将 IP 地址返回客户端，客户端和目标建立连接
> [!info] 解析域名首先会查看浏览器的缓存，再查看操作系统的缓存，再查看hosts文件，才会询问本地DNS服务器，而且本地DNS服务器还会缓存很多的TLD DNS服务器，实际查找中，无需访问根服务器，减少根服务器和TLD服务器的负担


---
## ARP
在传输一个 IP 数据报的时候，确定了源 IP 地址和目标 IP 地址后，就会通过主机「路由表」确定 IP 数据包下一跳，然而，网络层的下一层是数据链路层，所以我们还要知道「下一跳」的 MAC 地址

主机的路由表中可以找到下一跳的 IP 地址，所以可以通过 ==**ARP 协议**，求得下一跳的 MAC 地址==
==ARP 是借助 **ARP 请求与 ARP 响应**两种类型的包确定 MAC 地址的==
- 主机会通过**广播发送 ARP 请求**，这个包中包含了想要知道的 MAC 地址的主机 IP 地址
- 当同个链路中的所有设备收到 ARP 请求时，会去拆开 ARP 请求包里的内容，如果 ARP 请求包中的目标 IP 地址与自己的 IP 地址一致，那么这个设备就将自己的 MAC 地址塞入 **ARP 响应包**返回给主机
![[34.webp]]

### RARP
- ARP是已知IP地址求MAC地址
- RARP是已知MAC地址求IP地址
通常这需要架设一台 `RARP` 服务器，在这个服务器上注册设备的 MAC 地址及其 IP 地址。然后再将这个设备接入到网络

![[35.webp]]


---
## DHCP
通过 DHCP 动态获取 IP 地址，大大省去了配 IP 信息繁琐的过程
DHCP 交互中，**全程都是使用 UDP 广播通信**


---
## NAT
**网络地址转换 NAT** 的方法，再次缓解了 IPv4 地址耗尽的问题
简单的来说 NAT 就是同个公司、家庭、教室内的主机对外部通信时，==把私有 IP 地址转换成公有 IP 地址==
==把 IP 地址 + 端口号一起进行转换==
这种转换技术就叫**网络地址与端口转换 NAPT**
> [!warning] 缺点
> 由于 NAT/NAPT 都依赖于自己的转换表，因此会有以下的问题：
> - 外部无法主动与 NAT 内部服务器建立连接，因为 NAPT 转换表没有转换记录。
> - 转换表的生成与转换操作都会产生性能开销。
> - 通信过程中，如果 NAT 路由器重启了，所有的 TCP 连接都将被重置。

