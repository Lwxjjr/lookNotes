## 目录
```go
api                 通过api接口
config              配置文件中映射的结构体
core                初始化的一些连接操作
flags               命令行参数绑定
global              全局变量
middleware          中间件
models              表结构
plugins             插件包（日志）
routers             路由
service             服务
testdata            测试用例
uploads             上传的文件
utils               一些工具
go.mod
main.go             主函数
settings.yaml       配置文件
```

## yaml配置
```yaml
// settings.yaml
system:  
  ip: 127.0.0.1  
  port: 8080  
  env: dev  
mysql:  
  host: 127.0.0.1  
  port: 3306  
  config: charset=utf8mb4&parseTime=True&loc=Local  
  db: gn_db  
  username: root  
  password: "lwx757803@"  
  logLevel: error  
redis:  
  ip: 127.0.0.1  
  port: 6379  
  password: "lwx757803@"  
  db: 0  
  poolSize: 100  
jwt:  
  expires: 8  
  issuer: WxL  
  secret: uis&*jbb55dHRhf5
```

## 编写配置结构体：
所有属性分别对应`settings.yaml`的配置
```go
// config/enter.go
  
type Config struct {  
    System System `yaml:"system"`  
    Mysql  Mysql  `yaml:"mysql"`  
    Redis  Redis  `yaml:"redis"`  
    Jwt    Jwt    `yaml:"jwt"`  
    Site   Site   `yaml:"site"`
	ES     ES     `yaml:"es"`
}
```

## 配置全局变量
存放项目启动后的变量，方便调用
```go
// global.go
var (
	Config   *config.Config
	Log      *logrus.Logger
	DB       *gorm.DB
	Redis    *redis.Client
	ESClient *elastic.Client
	AddrDB   *geoip2.DBReader
)
```

## 载入配置
从配置文件`settings.yaml`文件中读取信息，并将其解析为`config.Config`
```go
// core/init_config.go
func InitConfig() (c *config.Config) {  
    byteData, err := os.ReadFile(yamlPath)  
    if err != nil {  
       logrus.Fatalln("read yaml err:", err.Error())  
    }  
    c = new(config.Config)  
    err = yaml.Unmarshal(byteData, c)  
    if err != nil {  
       logrus.Fatalln("解析 yaml err:", err.Error())  
    }  
    return c  
}
```

## 初始化数据库
```go
// core/init_mysql.go
func InitMysql() *gorm.DB {  
  
    if global.Config.Mysql.Host == "" {  
       logrus.Warn("未配置mysql，取消gorm连接")  
       return nil  
    }  
    dsn := global.Config.Mysql.Dsn()  
  
    var mysqlLogger logger.Interface  
  
    var logLevel = logger.Error  
    switch global.Config.Mysql.LogLevel {  
    case "info":  
       logLevel = logger.Info  
    case "warn":  
       logLevel = logger.Warn  
    }  
  
    mysqlLogger = logger.Default.LogMode(logLevel)  
    db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{  
       Logger:                                   mysqlLogger,  
       DisableForeignKeyConstraintWhenMigrating: true,  
    })  
    if err != nil {  
       logrus.Fatalf(fmt.Sprintf("[%s] mysql连接失败, err:%s", dsn, err.Error()))  
    }  
    sqlDB, _ := db.DB()  
    sqlDB.SetMaxIdleConns(10)               // 最大空闲连接数  
    sqlDB.SetMaxOpenConns(100)              // 最多可容纳  
    sqlDB.SetConnMaxLifetime(time.Hour * 4) // 连接最大复用时间，不能超过mysql的wait_timeout  
    return db  
}


func (m *Mysql) Dsn() string {  
    return fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?%s", m.Username, m.Password, m.Host, m.Port, m.DB, m.Config)  
}
```
## 初始化配置
```go
// main.go
func main() {
	global.Log = core.InitLogger()  
	global.Config = core.InitConfig()  
	global.DB = core.InitMysql()  
	global.Redis = core.InitRedis(0)
	
	option := flags.Parse()  
	if option.Run() {  
	    return  
	}
	...
}
```


## 命令行参数绑定

```go
// flags/enter.go
type Option struct {  
    DB   bool   // 初始化数据库  
    Port int    // 换端口  
    Load string // 导入数据库文件  
}  
  
func Parse() (option *Option) {  
    option = new(Option)  
    flag.BoolVar(&option.DB, "db", false, "初始化数据库")  
    flag.IntVar(&option.Port, "port", 0, "程序运行的端口")  
    flag.StringVar(&option.Load, "load", "", "导入sql数据库")  
    flag.Parse()  
    return option  
}  
  
// Run 根据里面的参数运行不同的脚本  
func (option Option) Run() bool {  
    if option.DB {  
       DB()  
       return true  
    }  
    if option.Port != 0 {  
       Port(option.Port)  
       return false  
    }  
    if option.Load != "" {  
       Load()  
       return true  
    }  
    return false  
}
```

```go
func DB() {  
    err := global.DB.Set("gorm:table_options", "ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci").  
       AutoMigrate(  
          &models.UserModel{},  
          &models.RoleModel{},  
          &models.DocModel{},  
          &models.UserCollDocModel{}, // 如果有自定义连接表，一定要放另外两张表的后面  
          &models.RoleDocModel{},  
          &models.ImageModel{},  
          &models.UserPwdDocModel{},  
          &models.LoginModel{},  
          &models.DocDataModel{},  
          &log_stash.LogModel{},  
       )
}

func Port(port int) {  
    global.Config.System.Port = port  
}


```

命令行中通过:
1. `-db` 来自动迁移我的schema，创建表
2. `-port ?` 来自定义端口