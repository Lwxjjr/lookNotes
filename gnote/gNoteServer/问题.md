### 1. 用户不存在
```go 
// jwts/enter.go

func (c CustomClaims) GetUser() (user *models.UserModel, err error) {  
    user = new(models.UserModel)  // 需要实例化
    err = global.DB.Take(user, c.UserID).Error  
    return  
}
```

---
### 2. 头像路径问题
```go
// user_update_info.go
if cr.Avatar != "" {  
    var image models.ImageModel  
    err = global.DB.Take(&image, "userID = ? AND path = ?", claims.UserID, cr.Avatar[1:]).Error  
    if err != nil {  
       res.FailWithMsg("用户头像不存在", c)  
       return  
    }  
}
```

---
### 3. gorm外键映射问题，小驼峰 -> 下划线，需要全部改动
![[Pasted image 20250409222531.png]]

---
### 4. 文档数查找
```go
1
 2
 3
  4
5
6
 7
 8
  9
user拥有的文档id列表为 [2, 3, 4, 6, 9]
2
3
 4
6
 9
```
递归查找不好写  
```go
1 1 
2 1.2
3 1.3 
4 1.3.4 
5 5 
6 6 
7 6.7 
8 6.8 9 
6.8.9
----------
2
3
 4
6
 9 
2 1.2 
3 1.3
4 1.3.4 
6 6 
9 6.8.9 
```
1. 先拿到角色拥有的文档id列表
2. 通过文档id列表查文档，拿到所有的key
3. 把这些key排序，从最短的开始,如果元素没有一个匹配的，那么它就作为根元素 [{6}, {2}, {3}] 
4. 依次通过==最大前缀匹配==，找到最符合自己的子元素 [{6:{9}}, {2}, {3:{4}}]

---
### 5. 文档内容问题

定义试看和密码的关系
```go
isDocFree := strings.Contains(doc.Content, global.DocSplitSign)  

var freeContent string  // 试看内容  
var content string // 正文内容
// 赋值文档内容  
if isDocFree {  
    _list := strings.Split(doc.Content, global.DocSplitSign)  
    freeContent = _list[0] // 在分隔符前面的是试看  
    var content = strings.ReplaceAll(doc.Content,global.DocSplitSign, "") // 正文  
}
```
==这样的情况查出来的content一直为空==
改成这样：
```go
isDocFree := strings.Contains(doc.Content, global.DocSplitSign)  
var content = strings.ReplaceAll(doc.Content, global.DocSplitSign, "") // 正文  
var freeContent string                                                 // 试看内容  
// 赋值文档内容  
if isDocFree {  
    _list := strings.Split(doc.Content, global.DocSplitSign)  
    freeContent = _list[0] // 在分隔符前面的是试看  
}  
  
if roleDoc.FreeContent != nil {  
    response.IsSee = true  
}
```

### 6. 超级管理员无法查看文档
因为连带删除，导致角色文档表没有记录，管理员也就无法查看文档  
在创建文档的时候，就在角色-文档表添加记录  
==超级管理员ID设计的时候就是1==
```go
// doc_create.go
// 自动加管理员和文档的权限  
global.DB.Create(&models.RoleDocModel{  
    RoleID: 1,  
    DocID:  docModel.ID,  
})
```

### 7. es安装问题
```c
docker run --name es -p 9200:9200  -p 9300:9300 -e "discovery.type=single-node" -e ES_JAVA_OPTS="-Xms512m -Xmx512m" -v D:\\docker\\es\\config\\elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v D:\\docker\\es\\data:/usr/share/elasticsearch/data -v D:\\docker\\es\\plugins:/usr/share/elasticsearch/plugins -d elasticsearch:7.12.0
```
虚拟内存设的不够大，无法访问`:9200`
1. [日常踩坑之es]([日常踩坑之elasticsearch docker 无法启动问题_查看es是否启动-CSDN博客](https://blog.csdn.net/qq_35919264/article/details/101360465))  
2. es header连接问题 ：
```c
#开启跨域支持
http.cors.enabled: true
#允许所有人跨域访问
http.cors.allow-origin: "*"
```
3. 还不能设置密码认证，一设置又会刚打开就关闭
