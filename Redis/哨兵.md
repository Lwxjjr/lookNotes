# 为什么需要哨兵
![[db568766644a4d10b8a91cdd2f8a4070.webp]]

==`Redis 2.8`以后提供的哨兵`Sentinel`机制，作用：**实现主从节点故障转换**==，它会监测主节点是否存活，如果发现主节点挂了，它就会选举一个从节点切换为主节点，并且把新主节点的相关信息通知给从节点和客户端


---
# 哨兵机制[[哨兵]]
哨兵是一个运行在特殊模式下的 Redis 进程，也是一个节点
哨兵节点主要负责三件事情：**监控、选主、通知**

---
# 监控故障
==哨兵会每隔 1 秒给所有主从节点发送 PING 命令==，当主从节点收到 PING 命令后，会发送一个响应命令给哨兵，这样就可以判断它们是否在正常运行
==如果主节点或者从节点没有在规定的时间内响应哨兵的 PING 命令，哨兵就会将它们标记为「**主观下线**」==（规定时间由`down-after-milliseconds`参数设定的，单位为毫秒）

> [!tip] 客观下线

主节点的系统压力比较大或者网络发送了拥塞，导致主节点没有在规定时间内响应哨兵的 PING 命令，为了减少误判的情况，哨兵在部署的时候不会只会部署一个节点，而是多个节点部署成哨兵集群（至少需要三台及其来部署哨兵集群）
==**通过多个哨兵节点一起判断，就可以就可以避免单个哨兵因为自身网络状况不好，而误判主节点下线的情况**==
![[13e4361407ba46979e802eaa654dcf67.webp]]
赞同票 = 配置`quorum`，主节点就会被哨兵标记为【客观下线】


---
# 谁来处理主从故障转移
==**哨兵是以哨兵集群的方式存在的**==
处理主从故障转移需要在哨兵集群中选出一个==`leader`，让其处理主从切换==
选举`leader`是一个投票的过程，在投票开始前，需要有个「候选者」
哪个哨兵先判断主节点【主观下线】，向其他实例发送`is-master-down-by-addr`命令，其他哨兵会根据自己和主节点的网络连接情况，做出赞成投票或者拒绝投票的响应
![[d0bed80d28a543fd8dcd299d4b06cf04.webp|450]]

当哨兵 B 收到赞成票数达到哨兵配置文件中的 quorum 配置项设定的值后，就会将主节点标记为「客观下线」，此时的哨兵 B 就是一个 Leader 候选者

> [!tip] 候选者怎么成为leader

候选者会向其他哨兵发送命令，表明希望成为 Leader 来执行主从切换，并让所有其他哨兵对它进行投票
任何一个「候选者」，要满足两个条件：
- 第一，拿到半数以上的赞成票；
- 第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值

> [!tip] 为什么哨兵节点至少需要3个

如果一个哨兵想要成功成为 Leader，必须获得 2 票，而不是 1 票
如果哨兵集群中有个哨兵挂掉了，那么就只剩一个哨兵了，如果这个哨兵想要成为 Leader，这时票数就没办法达到 2 票，就无法成功成为 Leader，这时是无法进行主从节点切换的
==**quorum 的值建议设置为哨兵个数的二分之一加 1**==
- 多数原则：只有超过一半的哨兵同意，系统才认可某个操作
- 故障容忍：最多可以容忍`(n-1)/2`个节点失效
- 保证一致性避免脑裂

---
# 哨兵集群怎么构成
```shell
sentinel monitor <master-name> <ip> <redis-port> <quorum> 
```
==**哨兵节点之间是通过 Redis 的发布者/订阅者机制来相互发现的**==
在主从集群中，主节点上有一个名为==`__sentinel__:hello`的频道==，不同哨兵就是通过它来相互发现，实现互相通信的
![[a6286053c6884cf58bf397d01674fe80.webp]]
